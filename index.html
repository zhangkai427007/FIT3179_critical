<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greater Kuala Lumpur Transport Visualisations</title>

  <!-- Vega / Vega-Lite / TopoJSON / Vega-Embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 28px; background:#f0f4f8; color:#111; }
    h1 { text-align:center; margin-bottom:6px; color:#003366; }
    .section-title { text-align:center; margin-top:28px; margin-bottom:6px; font-weight:bold; color:#1f78b4; }
    .vis { display:flex; justify-content:center; margin: 10px 0 30px; }
    #dbg { background:#fff; border:1px solid #ddd; padding:8px; border-radius:6px; max-width:980px; margin:12px auto; white-space:pre-wrap; display:none; font-size:13px; color:#444;}
  </style>
</head>
<body>
  <h1>Greater Kuala Lumpur — Transport Dashboard</h1>

  <div class="section-title">Urban Rail Network Map</div>
  <div class="vis" id="map_vis">Loading map…</div>

  <div class="section-title">Monthly Rail Ridership & Vehicle Count</div>
  <div class="vis" id="ridership_vis">Loading ridership chart…</div>

  <div id="dbg"></div>

<script>
  // debug helper
  function dbg(msg){
    try{
      const el = document.getElementById('dbg');
      el.style.display='block';
      el.textContent += msg + "\n";
    } catch(e){
      console.log(msg);
    }
  }

  // data files
  const mapSpecPath = 'https://raw.githubusercontent.com/zhangkai427007/FIT3179_critical/main/urban-map-json';
  const ridershipSpecPath = 'https://raw.githubusercontent.com/zhangkai427007/FIT3179_critical/main/ridership.json';
  const vehicleSpecPath = 'https://raw.githubusercontent.com/zhangkai427007/FIT3179_critical/main/vehicle.json';

  async function checkFile(path){
    try {
      dbg('Fetching ' + path + ' ...');
      const r = await fetch(path, {cache:'no-store'});
      dbg(path + ' status=' + r.status + ' content-type=' + (r.headers.get('content-type')||''));
      const preview = (await r.text()).slice(0,240).replace(/\n/g,' ');
      dbg('Preview: ' + preview);
      if (!r.ok) dbg('ERROR: HTTP ' + r.status + ' when fetching ' + path);
      if (preview.trim().startsWith('<')) dbg('WARNING: fetched content for ' + path + ' looks like HTML.');
      return r.ok;
    } catch(err){
      dbg('EXCEPTION fetching ' + path + ': ' + err);
      return false;
    }
  }

  (async function(){
    const okMap = await checkFile(mapSpecPath);
    const okRid = await checkFile(ridershipSpecPath);
    const okVeh = await checkFile(vehicleSpecPath);

    // Embed map
    if(okMap){
      vegaEmbed('#map_vis', mapSpecPath, {renderer:'svg', actions:true})
        .then(res => dbg('Map embedded successfully.'))
        .catch(err => { dbg('Map embed error: '+err); console.error(err); });
    } else {
      document.getElementById('map_vis').textContent='Map spec not reachable.';
    }

    // Combine ridership & vehicle charts as layered chart
    if(okRid && okVeh){
      const chartSpec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "description": "Monthly rail ridership and vehicle count for Greater KL",
        "width": 750,
        "height": 400,
        "layer": [
          {
            "data": {"url": ridershipSpecPath},
            "mark": {"type":"line","color":"#e0115f"},
            "encoding": {
              "x":{"field":"month","type":"temporal","title":"Month"},
              "y":{"field":"ridership","type":"quantitative","title":"Ridership"},
              "tooltip":[{"field":"line","title":"Line"},{"field":"ridership","title":"Ridership"}]
            }
          },
          {
            "data": {"url": vehicleSpecPath},
            "mark": {"type":"line","color":"#1f78b4"},
            "encoding": {
              "x":{"field":"month","type":"temporal","title":"Month"},
              "y":{"field":"vehicle_count","type":"quantitative","title":"Vehicle Count"},
              "tooltip":[{"field":"state","title":"State"},{"field":"vehicle_count","title":"Vehicle Count"}]
            }
          }
        ]
      };
      vegaEmbed('#ridership_vis', chartSpec, {renderer:'svg', actions:true})
        .then(res=>dbg('Ridership chart embedded successfully.'))
        .catch(err=>{ dbg('Ridership embed error: '+err); console.error(err); });
    } else {
      document.getElementById('ridership_vis').textContent='Ridership/Vehicle spec not reachable.';
    }

  })();
</script>

</body>
</html>
